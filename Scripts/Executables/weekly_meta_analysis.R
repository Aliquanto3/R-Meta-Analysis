################################################################################
#####                  MTG Tournament Result Analysis                      #####
#####                           by AnaÃ«l Yahi                              #####
#####               based on data generated by Phelps-san                  #####
#####            https://github.com/Badaro/MTGOArchetypeParser             #####
################################################################################
#####                              Main.R                                  #####
##### Use this file to get the weekly meta analysis for Discord servers    #####
################################################################################

########################   Import data and functions   ######################### 

# Import the parameters, libraries and functions from other scripts
# Once the code is stable, it should be turned into packages
ScriptDir = "Scripts/"
importableScriptDir = paste0(ScriptDir,"Imports/")

parameterScriptDir = paste0(importableScriptDir,"Parameters/")
source(file.path(paste0(parameterScriptDir,"Parameters.R")))

functionScriptDir = paste0(importableScriptDir,"Functions/")
source(file.path(paste0(functionScriptDir,"01-Tournament_Data_Import.R")))
source(file.path(paste0(functionScriptDir,"02-Metagame_Data_Treatment.R")))
source(file.path(paste0(functionScriptDir,"03-Metagame_Graph_Generation.R")))
# source(file.path(paste0(functionScriptDir,"04-Decklist_Analysis.R")))
source(file.path(paste0(functionScriptDir,"05-Player_Data_Treatment.R")))
source(file.path(paste0(functionScriptDir,"99-Output_Export.R")))





################################################################################
############################## PIONEER #########################################
################################################################################

MtgFormat = MtgFormats[3]
EventType = EventTypes[2]
# Create all the directories where results will be written
PathToLastDirs = 
  createResultDirectories(ResultDir, MtgFormat, Beginning, End, EventType,
                          CsvResultDir, PictureResultDir, TextResultDir)
TournamentResultFile = paste0(tournamentDataDir,MtgFormat,"_data.json")
#Import raw data
RawData = fromJSON(TournamentResultFile)[[1]]


tournamentDf = generate_df(
  RawData, EventType, MtgFormat, TournamentResultFile, Beginning, End)

### Compute analysis 

# Get the following columns: 
# Archetype Copies Players Matches MeasuredWinrate CI95LowerBound CI95UpperBound
archetypeMetricsDf = archetype_metrics(tournamentDf)

# Update the cut value based on the data. If too small, set at 1% for graph
# readability.
if(Share.autoupdate){
  StatShare = 
    round(mean(unlist(archetypeMetricsDf[Presence])) / 
            sum(unlist(archetypeMetricsDf[Presence])) * 100, digits = 2)
  ChartShare = max(StatShare, 1)
}else {
  StatShare = ChartShare
}

# Add the following columns:
# NormalizedPresence NormalizedMeasuredWinrate NormalizedSum Rank
archetypeRankingDf = archetype_ranking(archetypeMetricsDf, Presence)
# Keep only the most played decks and add some columns:
# Presence Tiers
archetypeTiersDf = archetype_tiers(archetypeRankingDf, Presence, StatShare)
# Get the required data to build the matchup matrix of the most present
# archetypes
muMatrixData = generate_matchup_data(tournamentDf, ChartShare, Presence)

exportTextAnalysis(tournamentDf, PathToLastDirs, Beginning, End, MtgFormat, 
                   EventType, ChartShare,TextResultDir)

### Draw the plots  

plotDir = paste0(PathToLastDirs,PictureResultDir)

# Draw the metagame pie chart
pieName = paste0(plotDir,"01_Presence-Pie-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_pie_chart(tournamentDf, ChartShare, Presence, Beginning, End, EventType,
                   MtgFormat)
ggsave(pieName, width = 27, height = 20, units = "cm")
dev.off()

# Draw the metagame bar chart
barName = paste0(plotDir,"02_Presence-Bar-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_bar_chart(tournamentDf, StatShare, Presence, Beginning, End, EventType, 
                   MtgFormat)
ggsave(barName, width = 30, height = 20, units = "cm")
dev.off()

# Draw the win rate graph with confidence intervals
winrateName = paste0(plotDir,"03_Winrate-Mustache-Box_", MtgFormat ,"_", 
                     Beginning, "_", End,"_By-", Presence, ".jpg")
winrates_graph(archetypeRankingDf, StatShare, Presence, Beginning, End,
               EventType, MtgFormat, SortValue)
ggsave(winrateName, width = 40, height = 20, units = "cm")
dev.off()

# Draw the repartition of archetypes by tier depending on their normalized score
normalizedSumName = paste0(plotDir,"04_Normalized-Sum-Scatterplot_", MtgFormat,
                           "_", Beginning, "_", End,"_By-", Presence, ".jpg")
normalized_sum_graph(archetypeRankingDf, StatShare, Presence,Beginning, End, 
                     EventType, MtgFormat)
ggsave(normalizedSumName, width = 80, height = 40, units = "cm")
dev.off()

# Draw the 2D map of the archetypes based on presence and win rate
winrateAndPresenceFullName = 
  paste0(plotDir,"05_Winrate-&-Presence-Full-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
simple_winrate_and_presence_graph(archetypeRankingDf, 0, Presence, 
                                  Diameters, Beginning, End, EventType, 
                                  MtgFormat, PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the 2D map of the most present archetypes based on presence and win rate,
# adding the metrics as labels
winrateAndPresenceFullName = 
  paste0(plotDir,"06_Winrate-&-Presence-Detailed-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
detailed_winrate_and_presence_graph(archetypeTiersDf, StatShare, Presence, 
                                    Beginning, End, EventType, MtgFormat, 
                                    PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the corresponding matchup matrix
matchupMatrixName = 
  paste0(plotDir,"07_Matchup-Matrix_", MtgFormat,"_", Beginning, "_", End,
         "_By-", Presence,".jpg")
generate_matchup_matrix(muMatrixData, ChartShare, Presence, Beginning, End,
                        MtgFormat, EventType)
ggsave(matchupMatrixName, width = 60, height = 30, units = "cm")
dev.off()

# Write the player results
exportPlayerData(tournamentDf,PathToLastDirs,Beginning,End,MtgFormat,EventType,
                 PlayerDataResultDir)

################################################################################
############################## PIONEER #########################################
################################################################################

MtgFormat = MtgFormats[3]
EventType = EventTypes[3]
# Create all the directories where results will be written
PathToLastDirs = 
  createResultDirectories(ResultDir, MtgFormat, Beginning, End, EventType,
                          CsvResultDir, PictureResultDir, TextResultDir)
TournamentResultFile = paste0(tournamentDataDir,MtgFormat,"_data.json")
#Import raw data
RawData = fromJSON(TournamentResultFile)[[1]]

tournamentDf = generate_df(
  RawData, EventType, MtgFormat, TournamentResultFile, Beginning, End)

### Compute analysis 

# Get the following columns: 
# Archetype Copies Players Matches MeasuredWinrate CI95LowerBound CI95UpperBound
archetypeMetricsDf = archetype_metrics(tournamentDf)

# Update the cut value based on the data. If too small, set at 1% for graph
# readability.
if(Share.autoupdate){
  StatShare = 
    round(mean(unlist(archetypeMetricsDf[Presence])) / 
            sum(unlist(archetypeMetricsDf[Presence])) * 100, digits = 2)
  ChartShare = max(StatShare, 1)
}else {
  StatShare = ChartShare
}

# Add the following columns:
# NormalizedPresence NormalizedMeasuredWinrate NormalizedSum Rank
archetypeRankingDf = archetype_ranking(archetypeMetricsDf, Presence)
# Keep only the most played decks and add some columns:
# Presence Tiers
archetypeTiersDf = archetype_tiers(archetypeRankingDf, Presence, StatShare)
# Get the required data to build the matchup matrix of the most present
# archetypes
muMatrixData = generate_matchup_data(tournamentDf, ChartShare, Presence)

exportTextAnalysis(tournamentDf, PathToLastDirs, Beginning, End, MtgFormat, 
                   EventType, ChartShare,TextResultDir)

### Draw the plots  

plotDir = paste0(PathToLastDirs,PictureResultDir)

# Draw the metagame pie chart
pieName = paste0(plotDir,"01_Presence-Pie-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_pie_chart(tournamentDf, ChartShare, Presence, Beginning, End, EventType,
                   MtgFormat)
ggsave(pieName, width = 27, height = 20, units = "cm")
dev.off()

# Draw the metagame bar chart
barName = paste0(plotDir,"02_Presence-Bar-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_bar_chart(tournamentDf, StatShare, Presence, Beginning, End, EventType, 
                   MtgFormat)
ggsave(barName, width = 30, height = 20, units = "cm")
dev.off()

# Draw the win rate graph with confidence intervals
winrateName = paste0(plotDir,"03_Winrate-Mustache-Box_", MtgFormat ,"_", 
                     Beginning, "_", End,"_By-", Presence, ".jpg")
winrates_graph(archetypeRankingDf, StatShare, Presence, Beginning, End,
               EventType, MtgFormat, SortValue)
ggsave(winrateName, width = 40, height = 20, units = "cm")
dev.off()

# Draw the repartition of archetypes by tier depending on their normalized score
normalizedSumName = paste0(plotDir,"04_Normalized-Sum-Scatterplot_", MtgFormat,
                           "_", Beginning, "_", End,"_By-", Presence, ".jpg")
normalized_sum_graph(archetypeRankingDf, StatShare, Presence,Beginning, End, 
                     EventType, MtgFormat)
ggsave(normalizedSumName, width = 80, height = 40, units = "cm")
dev.off()

# Draw the 2D map of the archetypes based on presence and win rate
winrateAndPresenceFullName = 
  paste0(plotDir,"05_Winrate-&-Presence-Full-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
simple_winrate_and_presence_graph(archetypeRankingDf, 0, Presence, 
                                  Diameters, Beginning, End, EventType, 
                                  MtgFormat, PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the 2D map of the most present archetypes based on presence and win rate,
# adding the metrics as labels
winrateAndPresenceFullName = 
  paste0(plotDir,"06_Winrate-&-Presence-Detailed-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
detailed_winrate_and_presence_graph(archetypeTiersDf, StatShare, Presence, 
                                    Beginning, End, EventType, MtgFormat, 
                                    PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the corresponding matchup matrix
matchupMatrixName = 
  paste0(plotDir,"07_Matchup-Matrix_", MtgFormat,"_", Beginning, "_", End,
         "_By-", Presence,".jpg")
generate_matchup_matrix(muMatrixData, ChartShare, Presence, Beginning, End,
                        MtgFormat, EventType)
ggsave(matchupMatrixName, width = 60, height = 30, units = "cm")
dev.off()

# Write the player results
exportPlayerData(tournamentDf,PathToLastDirs,Beginning,End,MtgFormat,EventType,
                 PlayerDataResultDir)

################################################################################
############################## MODERN ##########################################
################################################################################

MtgFormat = MtgFormats[4]
EventType = EventTypes[2]
# Create all the directories where results will be written
PathToLastDirs = 
  createResultDirectories(ResultDir, MtgFormat, Beginning, End, EventType,
                          CsvResultDir, PictureResultDir, TextResultDir)
TournamentResultFile = paste0(tournamentDataDir,MtgFormat,"_data.json")
#Import raw data
RawData = fromJSON(TournamentResultFile)[[1]]

tournamentDf = generate_df(
  RawData, EventType, MtgFormat, TournamentResultFile, Beginning, End)

### Compute analysis 

# Get the following columns: 
# Archetype Copies Players Matches MeasuredWinrate CI95LowerBound CI95UpperBound
archetypeMetricsDf = archetype_metrics(tournamentDf)

# Update the cut value based on the data. If too small, set at 1% for graph
# readability.
if(Share.autoupdate){
  StatShare = 
    round(mean(unlist(archetypeMetricsDf[Presence])) / 
            sum(unlist(archetypeMetricsDf[Presence])) * 100, digits = 2)
  ChartShare = max(StatShare, 1)
}else {
  StatShare = ChartShare
}

# Add the following columns:
# NormalizedPresence NormalizedMeasuredWinrate NormalizedSum Rank
archetypeRankingDf = archetype_ranking(archetypeMetricsDf, Presence)
# Keep only the most played decks and add some columns:
# Presence Tiers
archetypeTiersDf = archetype_tiers(archetypeRankingDf, Presence, StatShare)
# Get the required data to build the matchup matrix of the most present
# archetypes
muMatrixData = generate_matchup_data(tournamentDf, ChartShare, Presence)

exportTextAnalysis(tournamentDf, PathToLastDirs, Beginning, End, MtgFormat, 
                   EventType, ChartShare,TextResultDir)

### Draw the plots  

plotDir = paste0(PathToLastDirs,PictureResultDir)

# Draw the metagame pie chart
pieName = paste0(plotDir,"01_Presence-Pie-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_pie_chart(tournamentDf, ChartShare, Presence, Beginning, End, EventType,
                   MtgFormat)
ggsave(pieName, width = 27, height = 20, units = "cm")
dev.off()

# Draw the metagame bar chart
barName = paste0(plotDir,"02_Presence-Bar-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_bar_chart(tournamentDf, StatShare, Presence, Beginning, End, EventType, 
                   MtgFormat)
ggsave(barName, width = 30, height = 20, units = "cm")
dev.off()

# Draw the win rate graph with confidence intervals
winrateName = paste0(plotDir,"03_Winrate-Mustache-Box_", MtgFormat ,"_", 
                     Beginning, "_", End,"_By-", Presence, ".jpg")
winrates_graph(archetypeRankingDf, StatShare, Presence, Beginning, End,
               EventType, MtgFormat, SortValue)
ggsave(winrateName, width = 40, height = 20, units = "cm")
dev.off()

# Draw the repartition of archetypes by tier depending on their normalized score
normalizedSumName = paste0(plotDir,"04_Normalized-Sum-Scatterplot_", MtgFormat,
                           "_", Beginning, "_", End,"_By-", Presence, ".jpg")
normalized_sum_graph(archetypeRankingDf, StatShare, Presence,Beginning, End, 
                     EventType, MtgFormat)
ggsave(normalizedSumName, width = 80, height = 40, units = "cm")
dev.off()

# Draw the 2D map of the archetypes based on presence and win rate
winrateAndPresenceFullName = 
  paste0(plotDir,"05_Winrate-&-Presence-Full-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
simple_winrate_and_presence_graph(archetypeRankingDf, 0, Presence, 
                                  Diameters, Beginning, End, EventType, 
                                  MtgFormat, PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the 2D map of the most present archetypes based on presence and win rate,
# adding the metrics as labels
winrateAndPresenceFullName = 
  paste0(plotDir,"06_Winrate-&-Presence-Detailed-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
detailed_winrate_and_presence_graph(archetypeTiersDf, StatShare, Presence, 
                                    Beginning, End, EventType, MtgFormat, 
                                    PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the corresponding matchup matrix
matchupMatrixName = 
  paste0(plotDir,"07_Matchup-Matrix_", MtgFormat,"_", Beginning, "_", End,
         "_By-", Presence,".jpg")
generate_matchup_matrix(muMatrixData, ChartShare, Presence, Beginning, End,
                        MtgFormat, EventType)
ggsave(matchupMatrixName, width = 60, height = 30, units = "cm")
dev.off()

# Write the player results
exportPlayerData(tournamentDf,PathToLastDirs,Beginning,End,MtgFormat,EventType,
                 PlayerDataResultDir)

################################################################################
############################## MODERN ##########################################
################################################################################

MtgFormat = MtgFormats[4]
EventType = EventTypes[3]
# Create all the directories where results will be written
PathToLastDirs = 
  createResultDirectories(ResultDir, MtgFormat, Beginning, End, EventType,
                          CsvResultDir, PictureResultDir, TextResultDir)
TournamentResultFile = paste0(tournamentDataDir,MtgFormat,"_data.json")
#Import raw data
RawData = fromJSON(TournamentResultFile)[[1]]

tournamentDf = generate_df(
  RawData, EventType, MtgFormat, TournamentResultFile, Beginning, End)

### Compute analysis 

# Get the following columns: 
# Archetype Copies Players Matches MeasuredWinrate CI95LowerBound CI95UpperBound
archetypeMetricsDf = archetype_metrics(tournamentDf)

# Update the cut value based on the data. If too small, set at 1% for graph
# readability.
if(Share.autoupdate){
  StatShare = 
    round(mean(unlist(archetypeMetricsDf[Presence])) / 
            sum(unlist(archetypeMetricsDf[Presence])) * 100, digits = 2)
  ChartShare = max(StatShare, 1)
}else {
  StatShare = ChartShare
}

# Add the following columns:
# NormalizedPresence NormalizedMeasuredWinrate NormalizedSum Rank
archetypeRankingDf = archetype_ranking(archetypeMetricsDf, Presence)
# Keep only the most played decks and add some columns:
# Presence Tiers
archetypeTiersDf = archetype_tiers(archetypeRankingDf, Presence, StatShare)
# Get the required data to build the matchup matrix of the most present
# archetypes
muMatrixData = generate_matchup_data(tournamentDf, ChartShare, Presence)

exportTextAnalysis(tournamentDf, PathToLastDirs, Beginning, End, MtgFormat, 
                   EventType, ChartShare,TextResultDir)

### Draw the plots  

plotDir = paste0(PathToLastDirs,PictureResultDir)

# Draw the metagame pie chart
pieName = paste0(plotDir,"01_Presence-Pie-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_pie_chart(tournamentDf, ChartShare, Presence, Beginning, End, EventType,
                   MtgFormat)
ggsave(pieName, width = 27, height = 20, units = "cm")
dev.off()

# Draw the metagame bar chart
barName = paste0(plotDir,"02_Presence-Bar-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_bar_chart(tournamentDf, StatShare, Presence, Beginning, End, EventType, 
                   MtgFormat)
ggsave(barName, width = 30, height = 20, units = "cm")
dev.off()

# Draw the win rate graph with confidence intervals
winrateName = paste0(plotDir,"03_Winrate-Mustache-Box_", MtgFormat ,"_", 
                     Beginning, "_", End,"_By-", Presence, ".jpg")
winrates_graph(archetypeRankingDf, StatShare, Presence, Beginning, End,
               EventType, MtgFormat, SortValue)
ggsave(winrateName, width = 40, height = 20, units = "cm")
dev.off()

# Draw the repartition of archetypes by tier depending on their normalized score
normalizedSumName = paste0(plotDir,"04_Normalized-Sum-Scatterplot_", MtgFormat,
                           "_", Beginning, "_", End,"_By-", Presence, ".jpg")
normalized_sum_graph(archetypeRankingDf, StatShare, Presence,Beginning, End, 
                     EventType, MtgFormat)
ggsave(normalizedSumName, width = 80, height = 40, units = "cm")
dev.off()

# Draw the 2D map of the archetypes based on presence and win rate
winrateAndPresenceFullName = 
  paste0(plotDir,"05_Winrate-&-Presence-Full-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
simple_winrate_and_presence_graph(archetypeRankingDf, 0, Presence, 
                                  Diameters, Beginning, End, EventType, 
                                  MtgFormat, PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the 2D map of the most present archetypes based on presence and win rate,
# adding the metrics as labels
winrateAndPresenceFullName = 
  paste0(plotDir,"06_Winrate-&-Presence-Detailed-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
detailed_winrate_and_presence_graph(archetypeTiersDf, StatShare, Presence, 
                                    Beginning, End, EventType, MtgFormat, 
                                    PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the corresponding matchup matrix
matchupMatrixName = 
  paste0(plotDir,"07_Matchup-Matrix_", MtgFormat,"_", Beginning, "_", End,
         "_By-", Presence,".jpg")
generate_matchup_matrix(muMatrixData, ChartShare, Presence, Beginning, End,
                        MtgFormat, EventType)
ggsave(matchupMatrixName, width = 60, height = 30, units = "cm")
dev.off()

# Write the player results
exportPlayerData(tournamentDf,PathToLastDirs,Beginning,End,MtgFormat,EventType,
                 PlayerDataResultDir)

################################################################################
############################## PAUPER ##########################################
################################################################################

MtgFormat = MtgFormats[5]
EventType = EventTypes[7]
# Create all the directories where results will be written
PathToLastDirs = 
  createResultDirectories(ResultDir, MtgFormat, Beginning, End, EventType,
                          CsvResultDir, PictureResultDir, TextResultDir)
TournamentResultFile = paste0(tournamentDataDir,MtgFormat,"_data.json")
#Import raw data
RawData = fromJSON(TournamentResultFile)[[1]]

tournamentDf = generate_df(
  RawData, EventType, MtgFormat, TournamentResultFile, Beginning, End)

### Compute analysis 

# Get the following columns: 
# Archetype Copies Players Matches MeasuredWinrate CI95LowerBound CI95UpperBound
archetypeMetricsDf = archetype_metrics(tournamentDf)

# Update the cut value based on the data. If too small, set at 1% for graph
# readability.
if(Share.autoupdate){
  StatShare = 
    round(mean(unlist(archetypeMetricsDf[Presence])) / 
            sum(unlist(archetypeMetricsDf[Presence])) * 100, digits = 2)
  ChartShare = max(StatShare, 1)
}else {
  StatShare = ChartShare
}

# Add the following columns:
# NormalizedPresence NormalizedMeasuredWinrate NormalizedSum Rank
archetypeRankingDf = archetype_ranking(archetypeMetricsDf, Presence)
# Keep only the most played decks and add some columns:
# Presence Tiers
archetypeTiersDf = archetype_tiers(archetypeRankingDf, Presence, StatShare)
# Get the required data to build the matchup matrix of the most present
# archetypes
muMatrixData = generate_matchup_data(tournamentDf, ChartShare, Presence)

exportTextAnalysis(tournamentDf, PathToLastDirs, Beginning, End, MtgFormat, 
                   EventType, ChartShare,TextResultDir)

### Draw the plots  

plotDir = paste0(PathToLastDirs,PictureResultDir)

# Draw the metagame pie chart
pieName = paste0(plotDir,"01_Presence-Pie-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_pie_chart(tournamentDf, ChartShare, Presence, Beginning, End, EventType,
                   MtgFormat)
ggsave(pieName, width = 27, height = 20, units = "cm")
dev.off()

# Draw the metagame bar chart
barName = paste0(plotDir,"02_Presence-Bar-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_bar_chart(tournamentDf, StatShare, Presence, Beginning, End, EventType, 
                   MtgFormat)
ggsave(barName, width = 30, height = 20, units = "cm")
dev.off()

# Draw the win rate graph with confidence intervals
winrateName = paste0(plotDir,"03_Winrate-Mustache-Box_", MtgFormat ,"_", 
                     Beginning, "_", End,"_By-", Presence, ".jpg")
winrates_graph(archetypeRankingDf, StatShare, Presence, Beginning, End,
               EventType, MtgFormat, SortValue)
ggsave(winrateName, width = 40, height = 20, units = "cm")
dev.off()

# Draw the repartition of archetypes by tier depending on their normalized score
normalizedSumName = paste0(plotDir,"04_Normalized-Sum-Scatterplot_", MtgFormat,
                           "_", Beginning, "_", End,"_By-", Presence, ".jpg")
normalized_sum_graph(archetypeRankingDf, StatShare, Presence,Beginning, End, 
                     EventType, MtgFormat)
ggsave(normalizedSumName, width = 80, height = 40, units = "cm")
dev.off()

# Draw the 2D map of the archetypes based on presence and win rate
winrateAndPresenceFullName = 
  paste0(plotDir,"05_Winrate-&-Presence-Full-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
simple_winrate_and_presence_graph(archetypeRankingDf, 0, Presence, 
                                  Diameters, Beginning, End, EventType, 
                                  MtgFormat, PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the 2D map of the most present archetypes based on presence and win rate,
# adding the metrics as labels
winrateAndPresenceFullName = 
  paste0(plotDir,"06_Winrate-&-Presence-Detailed-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
detailed_winrate_and_presence_graph(archetypeTiersDf, StatShare, Presence, 
                                    Beginning, End, EventType, MtgFormat, 
                                    PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the corresponding matchup matrix
matchupMatrixName = 
  paste0(plotDir,"07_Matchup-Matrix_", MtgFormat,"_", Beginning, "_", End,
         "_By-", Presence,".jpg")
generate_matchup_matrix(muMatrixData, ChartShare, Presence, Beginning, End,
                        MtgFormat, EventType)
ggsave(matchupMatrixName, width = 60, height = 30, units = "cm")
dev.off()

# Write the player results
exportPlayerData(tournamentDf,PathToLastDirs,Beginning,End,MtgFormat,EventType,
                 PlayerDataResultDir)

################################################################################
############################## LEGACY ##########################################
################################################################################

MtgFormat = MtgFormats[6]
EventType = EventTypes[7]
# Create all the directories where results will be written
PathToLastDirs = 
  createResultDirectories(ResultDir, MtgFormat, Beginning, End, EventType,
                          CsvResultDir, PictureResultDir, TextResultDir)
TournamentResultFile = paste0(tournamentDataDir,MtgFormat,"_data.json")
#Import raw data
RawData = fromJSON(TournamentResultFile)[[1]]

tournamentDf = generate_df(
  RawData, EventType, MtgFormat, TournamentResultFile, Beginning, End)

### Compute analysis 

# Get the following columns: 
# Archetype Copies Players Matches MeasuredWinrate CI95LowerBound CI95UpperBound
archetypeMetricsDf = archetype_metrics(tournamentDf)

# Update the cut value based on the data. If too small, set at 1% for graph
# readability.
if(Share.autoupdate){
  StatShare = 
    round(mean(unlist(archetypeMetricsDf[Presence])) / 
            sum(unlist(archetypeMetricsDf[Presence])) * 100, digits = 2)
  ChartShare = max(StatShare, 1)
}else {
  StatShare = ChartShare
}

# Add the following columns:
# NormalizedPresence NormalizedMeasuredWinrate NormalizedSum Rank
archetypeRankingDf = archetype_ranking(archetypeMetricsDf, Presence)
# Keep only the most played decks and add some columns:
# Presence Tiers
archetypeTiersDf = archetype_tiers(archetypeRankingDf, Presence, StatShare)
# Get the required data to build the matchup matrix of the most present
# archetypes
muMatrixData = generate_matchup_data(tournamentDf, ChartShare, Presence)

exportTextAnalysis(tournamentDf, PathToLastDirs, Beginning, End, MtgFormat, 
                   EventType, ChartShare,TextResultDir)

### Draw the plots  

plotDir = paste0(PathToLastDirs,PictureResultDir)

# Draw the metagame pie chart
pieName = paste0(plotDir,"01_Presence-Pie-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_pie_chart(tournamentDf, ChartShare, Presence, Beginning, End, EventType,
                   MtgFormat)
ggsave(pieName, width = 27, height = 20, units = "cm")
dev.off()

# Draw the metagame bar chart
barName = paste0(plotDir,"02_Presence-Bar-Chart_", MtgFormat ,"_", Beginning, 
                 "_", End,"_By-", Presence, ".jpg")
metagame_bar_chart(tournamentDf, StatShare, Presence, Beginning, End, EventType, 
                   MtgFormat)
ggsave(barName, width = 30, height = 20, units = "cm")
dev.off()

# Draw the win rate graph with confidence intervals
winrateName = paste0(plotDir,"03_Winrate-Mustache-Box_", MtgFormat ,"_", 
                     Beginning, "_", End,"_By-", Presence, ".jpg")
winrates_graph(archetypeRankingDf, StatShare, Presence, Beginning, End,
               EventType, MtgFormat, SortValue)
ggsave(winrateName, width = 40, height = 20, units = "cm")
dev.off()

# Draw the repartition of archetypes by tier depending on their normalized score
normalizedSumName = paste0(plotDir,"04_Normalized-Sum-Scatterplot_", MtgFormat,
                           "_", Beginning, "_", End,"_By-", Presence, ".jpg")
normalized_sum_graph(archetypeRankingDf, StatShare, Presence,Beginning, End, 
                     EventType, MtgFormat)
ggsave(normalizedSumName, width = 80, height = 40, units = "cm")
dev.off()

# Draw the 2D map of the archetypes based on presence and win rate
winrateAndPresenceFullName = 
  paste0(plotDir,"05_Winrate-&-Presence-Full-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
simple_winrate_and_presence_graph(archetypeRankingDf, 0, Presence, 
                                  Diameters, Beginning, End, EventType, 
                                  MtgFormat, PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the 2D map of the most present archetypes based on presence and win rate,
# adding the metrics as labels
winrateAndPresenceFullName = 
  paste0(plotDir,"06_Winrate-&-Presence-Detailed-Scatterplot_", MtgFormat,"_", 
         Beginning, "_", End,"_By-", Presence,".jpg")
detailed_winrate_and_presence_graph(archetypeTiersDf, StatShare, Presence, 
                                    Beginning, End, EventType, MtgFormat, 
                                    PresenceAxisLogScale)
ggsave(winrateAndPresenceFullName, width = 60, height = 30, units = "cm")
dev.off()

# Draw the corresponding matchup matrix
matchupMatrixName = 
  paste0(plotDir,"07_Matchup-Matrix_", MtgFormat,"_", Beginning, "_", End,
         "_By-", Presence,".jpg")
generate_matchup_matrix(muMatrixData, ChartShare, Presence, Beginning, End,
                        MtgFormat, EventType)
ggsave(matchupMatrixName, width = 60, height = 30, units = "cm")
dev.off()

# Write the player results
exportPlayerData(tournamentDf,PathToLastDirs,Beginning,End,MtgFormat,EventType,
                 PlayerDataResultDir)