################################################################################
#####                  MTG Tournament Result Analysis                      #####
#####                           by AnaÃ«l Yahi                              #####
#####               based on data generated by Phelps-san                  #####
#####            https://github.com/Badaro/MTGOArchetypeParser             #####
################################################################################
#####                              Main.R                                  #####
##### Use this file as a controller of the others to generate most results #####
################################################################################

########################   Import data and functions   ######################### 

# Import the parameters, libraries and functions from other scripts
# Once the code is stable, it should be turned into packages
ScriptDir = "Scripts/"
importableScriptDir = paste0(ScriptDir,"Imports/")

parameterScriptDir = paste0(importableScriptDir,"Parameters/")
source(file.path(paste0(parameterScriptDir,"Parameters.R")))

functionScriptDir = paste0(importableScriptDir,"Functions/")
source(file.path(paste0(functionScriptDir,"01-Tournament_Data_Import.R")))
source(file.path(paste0(functionScriptDir,"02-Metagame_Data_Treatment.R")))
source(file.path(paste0(functionScriptDir,"03-Metagame_Graph_Generation.R")))
# source(file.path(paste0(functionScriptDir,"04-Decklist_Analysis.R")))
source(file.path(paste0(functionScriptDir,"05-Player_Data_Treatment.R")))
source(file.path(paste0(functionScriptDir,"99-Output_Export.R")))

# Create all the directories where results will be written
PathToLastDirs = 
  createResultDirectories(ResultDir, MtgFormat, Beginning, End, EventType,
                          CsvResultDir, PictureResultDir, TextResultDir)

#Import raw data
RawData = fromJSON(TournamentResultFile)[[1]]
sort(unique(RawData$Date))
unique(RawData$Tournament)
min(RawData$Date)
max(RawData$Date)

ChallengeData = RawData[RawData$Tournament %in% 
                          c("Modern Challenge","Modern Showcase Challenge",
                            "Modern Showcase Qualifier","Modern Super Qualifier", 
                            "Modern Challenge 96","Modern Qualifier",
                            "Modern Players Tour Qualifier"), ]

tournamentList = unique(ChallengeData$TournamentFile)
iterationNumber = length(tournamentList)
mostPresentArchetypeNumberInTop = setNames(rep(NA,iterationNumber), tournamentList)

for (i in 1:iterationNumber){
  ChallengeDataIteration = ChallengeData[ChallengeData$TournamentFile == tournamentList[i],]
  mostPresentArchetypeNumberInTop[i] = max(table(ChallengeDataIteration$Archetype$Archetype))
}
table(mostPresentArchetypeNumberInTop)
sort(mostPresentArchetypeNumberInTop[mostPresentArchetypeNumberInTop>=10])

RawData[RawData$TournamentFile=="modern-challenge-2021-02-1412261175",]$AnchorUri[1]
RawData[RawData$TournamentFile=="modern-challenge-2021-02-0712258815",]$AnchorUri[1]
RawData[RawData$TournamentFile=="modern-challenge-2022-07-3112450504",]$AnchorUri[1]
RawData[RawData$TournamentFile=="modern-challenge-2023-10-0612584882",]$AnchorUri[1]

RawData[RawData$TournamentFile=="modern-challenge-2023-10-0712584919",]$AnchorUri[1]
RawData[RawData$TournamentFile=="modern-challenge-2023-08-0412571722",]$AnchorUri[1]
RawData[RawData$TournamentFile=="modern-super-qualifier-2020-05-2512159748",]$AnchorUri[1]
RawData[RawData$TournamentFile=="modern-showcase-challenge-2020-03-0112098093",]$AnchorUri[1]
