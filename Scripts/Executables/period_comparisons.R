################################################################################
#####                  MTG Tournament Result Analysis                      #####
#####                           by AnaÃ«l Yahi                              #####
#####               based on data generated by Phelps-san                  #####
#####            https://github.com/Badaro/MTGOArchetypeParser             #####
################################################################################
#####                        period_comparison.R                           #####
##### Compare the metagame over different time spans                       #####
################################################################################

########################   Import data and functions   ######################### 

# Import the parameters, libraries and functions from other scripts
# Once the code is stable, it should be turned into packages
ScriptDir = "Scripts/"
importableScriptDir = paste0(ScriptDir,"Imports/")

parameterScriptDir = paste0(importableScriptDir,"Parameters/")
source(file.path(paste0(parameterScriptDir,"Parameters.R")))

functionScriptDir = paste0(importableScriptDir,"Functions/")
source(file.path(paste0(functionScriptDir,"01-Tournament_Data_Import.R")))
source(file.path(paste0(functionScriptDir,"02-Metagame_Data_Treatment.R")))
source(file.path(paste0(functionScriptDir,"03-Metagame_Graph_Generation.R")))
# source(file.path(paste0(functionScriptDir,"04-Decklist_Analysis.R")))
source(file.path(paste0(functionScriptDir,"05-Player_Data_Treatment.R")))
source(file.path(paste0(functionScriptDir,"99-Output_Export.R")))

#Import raw data
RawData = fromJSON(TournamentResultFile)[[1]]

Beginnings = c("2022-11-18", "2023-02-07")
Ends = c("2023-02-07", "2023-04-18")
Beginnings = sort(Beginnings)
Ends = sort(Ends)
stopifnot(length(Beginnings) == length(Ends))

# Create all the directories where results will be written
PathToLastDirs = 
  createResultDirectories(ResultDir, MtgFormat, Beginnings[1], 
                          Ends[length(Ends)], EventType,
                          CsvResultDir, PictureResultDir, TextResultDir)


timeSpansData = list()
mostPresentDecksOverSpan = list()
for (i in 1:length(Ends)){
  tournamentDf = generate_df(RawData, EventType, MtgFormat, TournamentResultFile, 
                             Beginnings[i], Ends[i])
  # Get the following columns: 
  # Archetype Copies Players Matches MeasuredWinrate CI95LowerBound ~
  # CI95UpperBound
  archetypeMetricsDf = archetype_metrics(tournamentDf)
  archetypeMetricsDf$Share = round(100 * archetypeMetricsDf$Matches / 
                                     sum(archetypeMetricsDf$Matches), 
                                   digits = 2)
  timeSpansData = append(timeSpansData, list(archetypeMetricsDf))
  # mostPresentDecksOverSpan = 
  #   append(mostPresentDecksOverSpan, archetypeMetricsDf[
  #     archetypeMetricsDf$Share > mean(archetypeMetricsDf$Share),]$Archetype)
  mostPresentDecksOverSpan = 
    append(mostPresentDecksOverSpan, archetypeMetricsDf[
      archetypeMetricsDf$Share > 1,]$Archetype)
}

decksToShow = unique(unlist(mostPresentDecksOverSpan))

PeriodComparisonData = data.frame(Archetype = decksToShow)

for (i in 1:length(timeSpansData)){
  timeSpansDataI = timeSpansData[[i]]
  PeriodComparisonData[,i+1] = 
    unlist(sapply(PeriodComparisonData$Archetype, function(archetype){
    valueToReturn = timeSpansDataI[timeSpansDataI$Archetype == archetype,]$Share
    return(ifelse(length(valueToReturn) == 0, 0, valueToReturn))
  }))
}

for (i in 1:length(timeSpansData)){
  timeSpansDataI = timeSpansData[[i]]
  PeriodComparisonData[,i+length(timeSpansData)+1] = 
    unlist(sapply(PeriodComparisonData$Archetype, function(archetype){
    valueToReturn = round(timeSpansDataI[
      timeSpansDataI$Archetype == archetype,]$MeasuredWinrate, digits = 2)
    return(ifelse(length(valueToReturn) == 0, 0, valueToReturn))
  }))
}

PeriodComparisonData = 
  PeriodComparisonData[PeriodComparisonData$Archetype != "Unknown", ]

shares = rep("Share between", length(Ends))
ands = rep("and", length(Ends))
winRates = rep("Win Rate between", length(Ends))

names(PeriodComparisonData) = 
  c("Archetype", paste(shares, Beginnings, ands, Ends), 
                       paste(winRates, Beginnings, ands, Ends))
PeriodComparisonData

PeriodComparisonDataDirPath = paste0(PathToLastDirs, PeriodComparisonDir)
PeriodComparisonDataFileName = 
  paste0(Beginnings[1],'_', Ends[length(Ends)], ' - Metagame Comparison in ', 
                            MtgFormat, ' ', EventType)
dir.create(file.path(PeriodComparisonDataDirPath))
write.csv(PeriodComparisonData, paste0(PeriodComparisonDataDirPath, 
                                       PeriodComparisonDataFileName,'.csv'), 
          row.names = FALSE)
write.xlsx(PeriodComparisonData, paste0(PeriodComparisonDataDirPath, 
                                        PeriodComparisonDataFileName,'.xlsx'), 
           row.names = FALSE)
