################################################################################
#####                  MTG Tournament Result Analysis                      #####
#####                           by AnaÃ«l Yahi                              #####
#####               based on data generated by Phelps-san                  #####
#####            https://github.com/Badaro/MTGOArchetypeParser             #####
################################################################################
#####                       07-Card_Data_Treatment.R                       #####
##### Use this file to import functions that will provide the classical    #####
##### Card analysis metrics.                                               #####
################################################################################

# # For development
# df = tournamentDf

#' Title
#'
#' @param df the dataframe generated by generate_df() 
#'
#' @return
#' @export
#'
#' @examples
get_card_data = function(df){
  
  # # For development only
  # df = tournamentDf
  
  Mainboards = lapply(df$Mainboard, function(MD){ MD$CardName })
  
  Sideboards = sapply(df$Sideboard, function(SB){ SB$CardName })
  
  MainboardCards = unique(unlist(Mainboards))
  SideboardCards = unique(unlist(Sideboards))
  
  CardData = data.frame(CardNames = unique(c(MainboardCards,SideboardCards)))
  
  print("1/7 - Identify in which decklist each card is")
  
  CardDecklistsPresence = lapply(CardData$CardNames, function(CardName){
    MDPresence = sapply(Mainboards, function(MD, name) {name %in% MD}, CardName)
    SBPresence = sapply(Sideboards, function(SB, name) {name %in% SB}, CardName)
    DecklistsPresence = (MDPresence | SBPresence)
    return(DecklistsPresence)
  })
  names(CardDecklistsPresence) = CardData$CardNames
  
  print("2/7 - Count the number of decklists where each card is")
  CardData$Decklist.Count = 
    sapply(CardDecklistsPresence, function(presenceInDecklists){n
      sum(presenceInDecklists)
      })
  CardData$Decklist.Share = round(100 * CardData$Decklist.Count / nrow(df), 
                                 digits = 2)
  
  print("3/7 - Get the win count of each card")
  
  CardData$Wins = sapply(CardDecklistsPresence, function(cardPresenceInDecklist, df){
    dfCard = df[cardPresenceInDecklist,]
    return(sum(dfCard$Wins))
  },df)
  print("4/7 - Get the loss count of each card")
  CardData$Losses = sapply(CardDecklistsPresence, function(cardPresenceInDecklist, df){
    dfCard = df[cardPresenceInDecklist,]
    return(sum(dfCard$Losses))
  },df)
  print("5/7 - Get the draws count of each card")
  CardData$Draws = sapply(CardDecklistsPresence, function(cardPresenceInDecklist, df){
    dfCard = df[cardPresenceInDecklist,]
    return(sum(dfCard$Draws))
  },df)
  print("6/7 - Add derived values (ex: CI)")
  CardData = CardData[CardData$Wins + CardData$Losses > 0,]
  CardData$Matches = CardData$Wins + CardData$Losses + CardData$Draws
  CardData$Win.Rate.Without.Draws = round(100 * CardData$Wins / 
    (CardData$Wins + CardData$Losses), digits = 2)
  CardData$Win.Rate.With.Draws = round(100 * CardData$Wins / CardData$Matches, 
                                       digits = 2)
  CardData$Match.Share = round(100 * CardData$Matches / 
                                    sum(df$Wins + df$Losses + df$Draws), 
                                  digits = 2)
  
  CardData$Win.Rate.CI.Lower.Bound = mapply(FUN = function(wins, defeats){
    round(binom.test(wins, wins + defeats, p = 0.5, alternative = "two.sided", 
                     conf.level = CIPercent)$conf.int[1] * 100, digits = 2)
  }, CardData$Wins, CardData$Losses)
  
  CardData$Win.Rate.CI.Upper.Bound =  mapply(FUN = function(wins, defeats){
    round(binom.test(wins, wins + defeats, p = 0.5, alternative = "two.sided", 
                     conf.level = CIPercent)$conf.int[2] * 100, digits = 2)
  }, CardData$Wins, CardData$Losses)
  
  CardData = CardData[order(CardData$Win.Rate.Without.Draws, decreasing = TRUE),]
  print("7/7 - About to export the card data table")
  CardData
}
