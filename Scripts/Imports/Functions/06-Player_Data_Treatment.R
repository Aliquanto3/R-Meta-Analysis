################################################################################
#####                  MTG Tournament Result Analysis                      #####
#####                           by AnaÃ«l Yahi                              #####
#####               based on data generated by Phelps-san                  #####
#####            https://github.com/Badaro/MTGOArchetypeParser             #####
################################################################################
#####                       06-Player_Data_Treatment.R                     #####
##### Use this file to import functions that will provide the classical    #####
##### player analysis metrics.                                             #####
################################################################################

#' Title
#'
#' @param df the dataframe generated by generate_df() 
#'
#' @return the player results with the following columns:
#' - Wins
#' - Losses
#' - Draws
#' - Number.of.Top32
#' - Number.of.Top8
#' - Number.of.Tournament.Wins
#' - Matches
#' - Win.Rate
#' - Win.Rate.CI.Lower.Bound
#' - Win.Rate.CI.Upper.Bound
#' @export
#'
#' @examples
get_player_data = function(df){
  
  # For development only
  df = tournamentDf
  
  playerDataDf = data.frame(Players = unique(df$Player))
  
  playerDataDf$Wins = rep(0, nrow(playerDataDf))
  playerDataDf$Losses = rep(0, nrow(playerDataDf))
  playerDataDf$Draws = rep(0, nrow(playerDataDf))
  playerDataDf$Number.of.Events = rep(0, nrow(playerDataDf))
  playerDataDf$Number.of.Top32 = rep(0, nrow(playerDataDf))
  playerDataDf$Number.of.Top8 = rep(0, nrow(playerDataDf))
  playerDataDf$Number.of.Tournament.Wins = rep(0, nrow(playerDataDf))
  
  # Goes over the initial table only once to add player data row by row,
  # instead of filtering the table for each player
  for (i in 1:nrow(df)){
    playerData = df[i,]
    
    playerDataDf[playerDataDf$Players == playerData$Player, ]$Number.of.Events = 
      playerDataDf[playerDataDf$Players == playerData$Player, ]$Number.of.Events + 1 
    
    playerDataDf[playerDataDf$Players == playerData$Player, ]$Wins = 
      playerDataDf[playerDataDf$Players == playerData$Player, ]$Wins + 
      playerData$Wins
    
    playerDataDf[playerDataDf$Players == playerData$Player, ]$Losses = 
      playerDataDf[playerDataDf$Players == playerData$Player, ]$Losses + 
      playerData$Losses
    
    playerDataDf[playerDataDf$Players == playerData$Player, ]$Draws = 
      playerDataDf[playerDataDf$Players == playerData$Player, ]$Draws + 
      playerData$Draws
    
    if(playerData$NumericResult <= 32 & playerData$NumericResult > 0){
      
      playerDataDf[playerDataDf$Players == 
                     playerData$Player, ]$Number.of.Top32 =
        playerDataDf[playerDataDf$Players == 
                       playerData$Player, ]$Number.of.Top32 + 1
      
      if(playerData$NumericResult <= 8 & playerData$NumericResult > 0){
        
        playerDataDf[playerDataDf$Players == 
                       playerData$Player, ]$Number.of.Top8 =
          playerDataDf[playerDataDf$Players == 
                         playerData$Player, ]$Number.of.Top8 + 1
        
        if(playerData$NumericResult == 1){
          
          playerDataDf[
            playerDataDf$Players == 
              playerData$Player, ]$Number.of.Tournament.Wins =
            playerDataDf[
              playerDataDf$Players == 
                playerData$Player, ]$Number.of.Tournament.Wins + 1
        }
      }
    }
  }
  
  playerDataDf$Matches = playerDataDf$Wins + playerDataDf$Losses + playerDataDf$Draws
  
  # # Remove players that appear in the JSON but don't have any recorded match
  # playerDataDf = playerDataDf[playerDataDf$Wins + playerDataDf$Losses >0,]
  
  playerDataDf$Win.Rate = round(100 * playerDataDf$Wins / 
                                (playerDataDf$Wins + playerDataDf$Losses), 
                              digits = 2)
  
  playerDataDf$Win.Rate.CI.Lower.Bound = mapply(FUN = function(wins, losses){
    round(binom.test(wins, wins + losses, p = 0.5, alternative = "two.sided", 
               conf.level = CIPercent)$conf.int[1] * 100, digits = 2)
  }, playerDataDf$Wins, playerDataDf$Losses)
  
  playerDataDf$Win.Rate.CI.Upper.Bound =  mapply(FUN = function(wins, losses){
    round(binom.test(wins, wins + losses, p = 0.5, alternative = "two.sided", 
               conf.level = CIPercent)$conf.int[2] * 100, digits = 2)
  }, playerDataDf$Wins, playerDataDf$Losses)
  
  playerDataDf = playerDataDf[order(playerDataDf$Win.Rate.CI.Lower.Bound,
                                    decreasing=TRUE),]
  
  playerDataDf
  
}
